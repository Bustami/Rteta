---
title: "Predict matches"
author: "robert hickman"
date: "17/09/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  warning = FALSE,message = FALSE
)
```

```{r}
library(tidyverse)
library(lubridate)
library(StatsBombR)
```


```{r}
free_data <- data.frame(
  match_id = 15946,
  competition.competition_id = "who",
  season.season_id = "cares"
)
data <- StatsBombR::get.matchFree(free_data)

periods <- data %>%
  mutate(time = as.numeric(hms(timestamp))) %>%
  dplyr::group_by(period) %>%
  dplyr::summarise(period_length = max(time))

shots <- data %>%
  dplyr::mutate(prev_time = map_dbl(period, function(p) {
    if(p == 1) {
      return(0)
    } else {
      sum(periods$period_length[periods$period < p])
    }
  })
  ) %>%
  dplyr::mutate(time = as.numeric(hms(timestamp)) + prev_time,
                shot_team = factor(team.name)) %>%
  dplyr::filter(type.name == "Shot") %>%
  dplyr::select(shot_team, shot_time = time, shot_xg = shot.statsbomb_xg)

sim_match <- function(data, teams, times, xgs, max_phase_length = 5, n_times = 10000) {
  both_teams <- levels(eval_tidy(enquo(teams), data))
  shot_teams <- eval_tidy(enquo(teams), data)
  shot_times <- eval_tidy(enquo(times), data)
  xgs <- eval_tidy(enquo(xgs), data)
  
  #filter out any non-xg coded events
  if(any(is.na(xgs))) {
    shot_teams <- shot_teams[-is.na(xgs)]
    shot_times <- shot_times[-is.na(xgs)]
    xgs <- xgs[-is.na(xgs)]
  }

  random_numbers <- runif(xgs)
  goals <- which(xgs > random_numbers)
  
  if(length(goals) == 0) {
    return("draw")
  } else {
    
    too_soon <- which(shot_times[goals] - lag(shot_times[goals]) < max_phase_length)
    if(length(too_soon) > 0) {
      goals <- goals[-too_soon]
    }
    
    team_goals <- shot_teams[goals]
    tabled_goals<- table(team_goals)
    z <<- tabled_goals
    
    if(tabled_goals[[1]] == tabled_goals[[2]]) {
      return("draw")
    } else if(tabled_goals[[1]] > tabled_goals[[2]]) {
      return(both_teams[[1]])
    } else {
      return(both_teams[[2]])
    }
  }
}

sims <- purrr::rerun(1000, sim_match(shots, shot_team, shot_time, shot_xg))
sim_results <- table(unlist(sims))

sim_results
```
```{r}
p <- ggplot(data.frame(sim_results), aes(y = Freq/sum(Freq), fill = Var1)) +
  geom_bar()

p
```

